<!DOCTYPE html>
<html>
<head>
    <title>{{ title }}</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 20px;
        }
        .section {
            margin-bottom: 30px;
        }
        .card {
            margin-bottom: 15px;
        }
        .card-body {
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        .card-title {
            color: #007bff;
        }
        .table thead th {
            background-color: #007bff;
            color: #fff;
        }
    </style>
    <script>
        {% set cleaned_node_address = node_address | replace("http://", "") %}
        let blockchainData;

        async function fetchChain() {
            const response = await fetch('{{node_address}}/chain');
            blockchainData = await response.json();
            fetchBlockDetails();
        }

        function fetchBlockDetails() {
            const index = '{{index}}';

            const block = blockchainData.chain.find(b => b.index == index);

            if (!block) {
                document.body.innerHTML = '<div class="container"><h1>Block not found</h1></div>';
                return;
            }

            document.getElementById('block-index').textContent = block.index;
            document.getElementById('block-hash').textContent = block.hash;
            document.getElementById('block-timestamp').textContent = new Date(block.timestamp * 1000).toLocaleString();
            document.getElementById('block-prev-hash').textContent = block.previous_hash;
            document.getElementById('block-beneficiary').textContent = block.coinbase_beneficiary;
            document.getElementById('block-nonce').textContent = block.nonce;

            const txOutput = document.getElementById('transactions');
            block.transactions.forEach(tx => {
                const txCard = document.createElement('div');
                txCard.className = 'card';
                txCard.innerHTML = `
                    <div class="card-body">
                        <p class="card-title"><strong>Hash:</strong> ${tx.hash} </p>
                        <p class="card-text"><strong>Input Public Key:</strong> ${tx.input_public_key}</p>
                        <p class="card-text"><strong>Output Public Key:</strong> ${tx.output_public_key}</p>
                        <p class="card-text"><strong>Amount:</strong> ${tx.amount}</p>
                        <p class="card-text"><strong>Fee:</strong> ${tx.fee}</p>
                        <p class="card-text"><strong>Signature:</strong> ${tx.signature}</p>
                        <p class="card-text"><strong>Timestamp:</strong> ${new Date(tx.timestamp * 1000).toLocaleString()}</p>
                    </div>
                `;
                txOutput.appendChild(txCard);
            });

            const utxoOutput = document.getElementById('utxo-pool');
            let totalBalance = 0;
            Object.keys(block.utxo_pool).forEach(key => {
                const utxo = block.utxo_pool[key];
                totalBalance += utxo.amount;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${utxo.public_key}</td>
                    <td>${utxo.amount}</td>
                `;
                utxoOutput.appendChild(row);
            });
            
            // Round the total balance to 3 decimal places
            totalBalance = totalBalance.toFixed(3);

            // Create a row for the total balance
            const totalRow = document.createElement('tr');
            totalRow.innerHTML = `
                <td><strong>Total</strong></td>
                <td><strong>${totalBalance}</strong></td>
            `;

            // Append the total balance row to the table
            utxoOutput.appendChild(totalRow);
        }

        window.onload = fetchChain;
    </script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="{{frontend_address}}/">Blockchain Interface</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavDropdown">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="{{frontend_address}}/mempool?node_address={{node_address}}">View Mempool</a>
                </li>
            </ul>
            <span class="navbar-text ml-auto">
                Connected to {{cleaned_node_address}}
            </span>
        </div>
    </nav>
    <div class="container">
        <h1 class="my-4">Block Details</h1>
        <div class="section">
            <h2>Block Information</h2>
            <div class="card">
                <div class="card-body">
                    <p><strong>Index:</strong> <span id="block-index"></span></p>
                    <p><strong>Hash:</strong> <span id="block-hash"></span></p>
                    <p><strong>Timestamp:</strong> <span id="block-timestamp"></span></p>
                    <p><strong>Previous Hash:</strong> <span id="block-prev-hash"></span></p>
                    <p><strong>Coinbase Beneficiary:</strong> <span id="block-beneficiary"></span></p>
                    <p><strong>Nonce:</strong> <span id="block-nonce"></span></p>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>Transactions</h2>
            <div id="transactions"></div>
        </div>
        <div class="section">
            <h2>UTXO Pool</h2>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Public Key</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody id="utxo-pool"></tbody>
            </table>
        </div>
    </div>
</body>
</html>
